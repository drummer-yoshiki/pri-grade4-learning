<!DOCTYPE html>
<html lang="ja">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>AI英単語テスト生成ツール</title>
 <style>
 body {
 font-family: Arial, sans-serif;
 margin: 20px;
 background-color: #f4f4f4;
 color: #333;
 }
 .container {
 max-width: 800px;
 margin: 0 auto;
 padding: 20px;
 background-color: #fff;
 border-radius: 8px;
 box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
 }
 h1 {
 color: #4a90e2;
 text-align: center;
 }
 .controls {
 text-align: center;
 margin-bottom: 20px;
 }
 #generate-btn {
 padding: 10px 20px;
 font-size: 16px;
 color: #fff;
 background-color: #5cb85c;
 border: none;
 border-radius: 5px;
 cursor: pointer;
 transition: background-color 0.3s;
 }
 #generate-btn:hover {
 background-color: #4cae4c;
 }
 #loading-message {
 text-align: center;
 font-style: italic;
 color: #888;
 margin-top: 10px;
 display: none;
 }
 .quiz-container {
 margin-top: 20px;
 padding: 20px;
 border: 1px solid #ddd;
 border-radius: 8px;
 background-color: #fafafa;
 }
 .question {
 margin-bottom: 15px;
 padding: 10px;
 border-bottom: 1px solid #eee;
 }
 .dialogue-text {
    white-space: pre-wrap;
    font-size: 1.1em;
    margin-bottom: 10px;
    line-height: 1.6;
 }
 .options-list {
 list-style: none;
 padding: 0;
 margin: 0;
 }
 .option-item {
 margin-bottom: 5px;
 padding: 10px;
 border: 1px solid #ccc;
 border-radius: 5px;
 cursor: pointer;
 transition: background-color 0.2s;
 }
 .option-item:hover {
 background-color: #e9e9e9;
 }
 .correct-answer {
 background-color: #d4edda;
 border-color: #c3e6cb;
 font-weight: bold;
 }
 .incorrect-answer {
 background-color: #f8d7da;
 border-color: #f5c6cb;
 }
 .rationale {
 font-size: 0.9em;
 color: #555;
 margin-top: 10px;
 display: none;
 padding: 10px;
 background-color: #f1f1f1;
 border-radius: 5px;
 }
 .error-box {
     border: 2px solid #f5c6cb;
     background-color: #f8d7da;
     color: #721c24;
     padding: 15px;
     margin-top: 20px;
     border-radius: 5px;
 }
 .error-box h4 {
     margin-top: 0;
 }
 .error-box pre {
     white-space: pre-wrap;
     word-wrap: break-word;
     background-color: #f0f0f0;
     padding: 10px;
     border: 1px solid #ccc;
     border-radius: 5px;
     color: #333;
 }
 </style>
</head>
<body>
 <div class="container">
 <h1>AI英単語テスト生成ツール</h1>
 <div class="controls">
 <button id="generate-btn">テストを生成する</button>
 </div>
 <div id="loading-message">生成中です...しばらくお待ちください。</div>
 <div id="quiz-area"></div>
 </div>

 <script>
 const API_KEY = 'AIzaSyAHcj_aoEVG8MqCmYejIu9Co6gs1vEh8iQ';
 const generateBtn = document.getElementById('generate-btn');
 const quizArea = document.getElementById('quiz-area');
 const loadingMessage = document.getElementById('loading-message');

 const promptTemplates = {
    fillInTheBlank: `英検4級レベルの「__THEME__」をテーマにした英文（最大7語）の穴埋め問題を1問だけ作成してください。**文の状況設定は「__CONTEXT__」に関連させてください。**
**【最重要原則】**
- 正解の選択肢は、文法・文脈において**完全に正しいものが1つだけ**です。
- 他3つの不正解の選択肢は、**それを空欄に入れると英文が文法的に成立しなくなる（grammatically incorrect）**ように作成してください。

**【出力形式】**
- 問題(\`question\`)と選択肢(\`options\`)は必ず英語で作成してください。
- 解説(\`explanation\`)は、**なぜその選択肢が正解で、他が不正解なのかを学習者が理解できるように、必ず日本語で具体的に説明**してください。
- 選択肢(\`options\`)は、**必ず4つの要素を持つ配列**にしてください。
- JSONのキーは必ず question, options, answer, explanation としてください。`,
    dialogue: `英検4級レベルの「__THEME__」をテーマにした対話形式（各話者の発言は最大7語）の選択問題を1問だけ作成してください。**対話の状況設定は「__CONTEXT__」に関連させてください。**
**【最重要原則】**
- 正解の選択肢は、**話者にとって自然で論理的な応答であり、文法・文脈において完全に正しいものが1つだけ**です。
- 他3つの不正解の選択肢は、**質問と全く関係ない、または文脈に合わない応答とし、__THEME__を含まないもの**にしてください。

**【問題作成のルール】**
- AとBの短い英語の対話文を作成します。
- 正解の選択肢は、必ずテーマ「__THEME__」を含んでおり、最大5語までとします。

**【出力形式】**
- 問題(\`question\`)と選択肢(\`options\`)は必ず英語で作成してください。
- 解説(\`explanation\`)は、**なぜその選択肢が正解で、他が不正解なのかを学習者が理解できるように、必ず日本語で具体的に説明**してください。
- 選択肢(\`options\`)は、**必ず4つの要素を持つ配列**にしてください。
- JSONのキーは必ず question, options, answer, explanation としてください。`
 };
 
 const contexts = [
    "学校生活について", "趣味や自由時間について", "家族や家について", "食べ物やレストランについて",
    "買い物について", "旅行や休日について", "スポーツについて", "天気について"
 ];

 const questionTypes = ['fillInTheBlank', 'dialogue'];
 
 async function loadThemes() {
    const response = await fetch('english-test/list.txt');
    if (!response.ok) {
        throw new Error('ファイルが見つかりません: english-test/list.txt を確認してください。');
    }
    const text = await response.text();
    return text.split('\n')
               .map(line => line.trim())
               .filter(line => line.length > 0);
 }

 async function fetchSingleQuestion(theme, type, context) {
    try {
        const template = promptTemplates[type];
        let finalPrompt = template.replaceAll('__THEME__', theme);
        finalPrompt = finalPrompt.replaceAll('__CONTEXT__', context);
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
        const data = { contents: [{ parts: [{ text: finalPrompt }] }] };

        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            console.error(`APIエラー: ${response.status}`);
            return null;
        }

        const responseData = await response.json();
        if (responseData.candidates && responseData.candidates.length > 0) {
            const generatedText = responseData.candidates[0].content.parts[0].text;
            const jsonMatch = generatedText.match(/```json\s*(\{[\s\S]*?\})\s*```|(\{[\s\S]*?\})/);
            if (!jsonMatch) {
                console.error("応答からJSONデータが見つかりませんでした。");
                return null;
            }
            const jsonString = jsonMatch[1] || jsonMatch[2];
            const questionData = JSON.parse(jsonString);
            questionData.type = type;
            return questionData;
        }
        return null;
    } catch (error) {
        console.error("単一の問題取得中にエラー:", error);
        return null;
    }
 }

 async function callGeminiAPI() {
    if (API_KEY === 'あなたのAPIキーをここに貼り付けてください' || API_KEY.trim() === '') {
        alert('APIキーが設定されていません。コード内の API_KEY を書き換えてください。');
        return;
    }

    quizArea.innerHTML = "";
    loadingMessage.style.display = 'block';
    generateBtn.disabled = true;

    try {
        const themes = await loadThemes();

        if (themes.length < 5) {
            throw new Error('list.txtには少なくとも5つのテーマを記載してください。');
        }

        const questionObjects = [];
        const maxAttempts = 15;
        let attempts = 0;
        
        const shuffledThemes = themes.sort(() => 0.5 - Math.random());
        
        while(questionObjects.length < 5 && attempts < maxAttempts) {
            const theme = shuffledThemes[attempts % shuffledThemes.length];
            const randomType = questionTypes[Math.floor(Math.random() * questionTypes.length)];
            const randomContext = contexts[Math.floor(Math.random() * contexts.length)];
            
            let question = await fetchSingleQuestion(theme, randomType, randomContext);

            if (
                question &&
                question.options && Array.isArray(question.options) &&
                question.question &&
                question.answer &&
                question.explanation && typeof question.explanation === 'string' && question.explanation.trim().length > 0
            ) {
                if (question.options.length > 4) {
                    question.options = question.options.slice(0, 4);
                    if ( ! (question.options.some(opt => String(opt).trim() === String(question.answer).trim())) ) {
                        question = null; 
                    }
                }
                if (question) {
                    questionObjects.push(question);
                }
            } else {
                console.warn('生成された問題が不完全なためスキップされました:', question);
            }
            attempts++;
        }

        if (questionObjects.length < 5) {
            throw new Error(`問題の生成に失敗しました。（試行回数: ${attempts}）`);
        }
        
        const quizData = { questions: questionObjects };
        displayQuiz(quizData);

    } catch (error) {
        console.error('エラーが発生しました:', error);
        quizArea.innerHTML = `<div class="error-box"><h4>エラー</h4><p>${error.message}</p></div>`;
    } finally {
        loadingMessage.style.display = 'none';
        generateBtn.disabled = false;
    }
 }
 
 function displayQuiz(quizData) {
    const questions = quizData.questions;
    if (!questions || !Array.isArray(questions)) {
        quizArea.innerHTML = `<p>エラー: 応答のJSON形式が不正です。</p>`;
        return;
    }
    
    quizArea.innerHTML = '';

    questions.forEach((q, index) => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'question';

        const questionText = document.createElement('div');
        questionText.className = 'dialogue-text';
        questionText.innerHTML = `<strong>問題${index + 1}:</strong>\n${q.question}`;
        questionDiv.appendChild(questionText);
        
        const answerOptions = q.options.map(optionElement => {
            let textValue;
            if (typeof optionElement === 'string') {
                textValue = optionElement;
            } 
            else if (typeof optionElement === 'object' && optionElement !== null) {
                textValue = Object.values(optionElement)[0] || '';
            } 
            else {
                textValue = '';
            }

            const answerText = (typeof q.answer === 'object' && q.answer !== null) 
                ? Object.values(q.answer)[0] 
                : q.answer;

            return {
                text: String(textValue),
                isCorrect: (String(textValue).trim() === String(answerText).trim()),
                rationale: q.explanation
            };
        });

        const optionsList = document.createElement('ul');
        optionsList.className = 'options-list';
        answerOptions.forEach(option => {
            const optionItem = document.createElement('li');
            optionItem.className = 'option-item';
            optionItem.textContent = option.text;
            optionItem.onclick = () => showResult(option, questionDiv, optionsList, answerOptions);
            optionsList.appendChild(optionItem);
        });
        questionDiv.appendChild(optionsList);
        
        quizArea.appendChild(questionDiv);
    });
 }

 function showResult(clickedOption, questionDiv, optionsList, allOptions) {
    const rationaleDiv = document.createElement('div');
    rationaleDiv.className = 'rationale';
    rationaleDiv.textContent = `解説: ${clickedOption.rationale}`;
    rationaleDiv.style.display = 'block';

    const existingRationale = questionDiv.querySelector('.rationale');
    if (existingRationale) { existingRationale.remove(); }
    
    Array.from(optionsList.children).forEach(item => {
        item.classList.remove('correct-answer', 'incorrect-answer');
        item.onclick = null;
    });

    const clickedItem = Array.from(optionsList.children).find(item => item.textContent.trim() === clickedOption.text.trim());

    if (clickedOption.isCorrect) {
        if(clickedItem) clickedItem.classList.add('correct-answer');
    } else {
        if(clickedItem) clickedItem.classList.add('incorrect-answer');
        
        const correctItem = Array.from(optionsList.children).find(item => {
            const matchedOption = allOptions.find(opt => opt.text.trim() === item.textContent.trim());
            return matchedOption && matchedOption.isCorrect;
        });
        if (correctItem) { correctItem.classList.add('correct-answer'); }
    }
    
    questionDiv.appendChild(rationaleDiv);
 }

 generateBtn.addEventListener('click', callGeminiAPI);
 </script>
</body>
</html>